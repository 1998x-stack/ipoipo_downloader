# IPOæŠ¥å‘Šä¸‹è½½å™¨ - é˜²ç›—é“¾ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

ä¸‹è½½æŠ¥å‘Šæ—¶é‡åˆ° 403 Forbidden é”™è¯¯ï¼š
```
403 Forbidden
æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤æœåŠ¡å™¨ä¸Šçš„ URL
è¢«è½¬è¯ŠåŒ»ç”Ÿæ‹’ç»ï¼ˆå®é™…æ˜¯ Referrer deniedï¼‰
ç”± TengineCDN æä¾›æ”¯æŒ
```

## ğŸ” é—®é¢˜æ ¹å› 

Tengine CDNï¼ˆé˜¿é‡Œäº‘ï¼‰ä½¿ç”¨ **Referer ACL ç™½åå•**è¿›è¡Œé˜²ç›—é“¾ï¼š
- åªå…è®¸æ¥è‡ª `ipoipo.cn` åŸŸåçš„ Referer
- ç›´æ¥è¯·æ±‚ ZIP URL ä¼šè¢«æ‹’ç»
- ç©º Referer æˆ–ä¸åœ¨ç™½åå•çš„ Referer è¿”å› 403

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®æ”¹

1. **HTTPClient** (`core/http_client.py`)
   - ä½¿ç”¨ `requests.Session()` ä¿æŒ cookies
   - æ–°å¢ `download_file()` æ–¹æ³•æ”¯æŒè®¾ç½® Referer
   - æ–°å¢ `_last_status_code` è·Ÿè¸ªçŠ¶æ€ç 

2. **DownloadScraper** (`scrapers/download_scraper.py`)
   - `get_zip_download_url()` è¿”å› `(zip_url, download_page_url)`
   - ä¸‹è½½æ—¶ä½¿ç”¨ä¸‹è½½é¡µé¢ URL ä½œä¸º Referer

3. **Downloader** (`download/downloader.py`)
   - å…ˆè®¿é—®ä¸‹è½½é¡µé¢å»ºç«‹ session
   - ä½¿ç”¨æ­£ç¡®çš„ Referer ä¸‹è½½æ–‡ä»¶
   - **æ–°å¢ï¼šé‡åˆ° 403 è‡ªåŠ¨åˆ‡æ¢ä»£ç†å¹¶é‡è¯•**
   - **æ–°å¢ï¼šè¿ç»­å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ä»£ç†**

4. **main.py**
   - ä½¿ç”¨ `proxy_manager.select_random()` é€‰æ‹©ä»£ç†èŠ‚ç‚¹
   - æ–°å¢ `--retry` å‘½ä»¤é‡è¯•å¤±è´¥ä¸‹è½½
   - æ–°å¢ `--extract` å‘½ä»¤è§£å‹å·²ä¸‹è½½æ–‡ä»¶
   - **æ–°å¢ï¼š`switch_proxy_node()` è‡ªåŠ¨åˆ‡æ¢ä»£ç†**

### ä»£ç†è‡ªåŠ¨åˆ‡æ¢æµç¨‹

```
download_report() 
    â”‚
    â”œâ”€ å°è¯•ä¸‹è½½
    â”‚     â”‚
    â”‚     â””â”€ 403 Forbidden?
    â”‚           â”‚
    â”‚           â”œâ”€ Yes â†’ switch_proxy_node()
    â”‚           â”‚           â”‚
    â”‚           â”‚           â”œâ”€ æ ‡è®°å½“å‰èŠ‚ç‚¹å¤±è´¥
    â”‚           â”‚           â”œâ”€ é€‰æ‹©æ–°çš„éšæœºèŠ‚ç‚¹
    â”‚           â”‚           â”œâ”€ æ›´æ–° session.proxies
    â”‚           â”‚           â”œâ”€ æ¸…é™¤ cookies
    â”‚           â”‚           â””â”€ é‡è¯•ä¸‹è½½
    â”‚           â”‚
    â”‚           â””â”€ No â†’ æ£€æŸ¥è¿ç»­å¤±è´¥æ¬¡æ•°
    â”‚                     â”‚
    â”‚                     â””â”€ >= 2æ¬¡ â†’ switch_proxy_node() â†’ é‡è¯•
    â”‚
    â””â”€ æˆåŠŸ â†’ é‡ç½®å¤±è´¥è®¡æ•°
```

### å…³é”®ä»£ç 

```python
# 1. åˆ›å»º Sessionï¼ˆä¿æŒ cookiesï¼‰
session = requests.Session()

# 2. å…ˆè®¿é—®ä¸‹è½½é¡µé¢
download_page_url = "https://ipoipo.cn/xiazai/{post_id}/"
session.get(download_page_url)

# 3. ä½¿ç”¨æ­£ç¡®çš„ Referer ä¸‹è½½
headers = {'Referer': download_page_url}
session.get(zip_url, headers=headers, stream=True)
```

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

```
ipo_downloader/
â”œâ”€â”€ core/
â”‚   â””â”€â”€ http_client.py      # ä¿®å¤ï¼šä½¿ç”¨Sessionï¼Œæ–°å¢download_file
â”œâ”€â”€ scrapers/
â”‚   â””â”€â”€ download_scraper.py # ä¿®å¤ï¼šè¿”å›referer URL
â”œâ”€â”€ download/
â”‚   â””â”€â”€ downloader.py       # ä¿®å¤ï¼šæ­£ç¡®è®¾ç½®Referer
â”œâ”€â”€ main.py                 # ä¿®å¤ï¼šä½¿ç”¨select_random()
â”œâ”€â”€ test_anti_hotlink.py    # æ–°å¢ï¼šæµ‹è¯•è„šæœ¬
â””â”€â”€ README_FIX.md           # æ–°å¢ï¼šæœ¬æ–‡æ¡£
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯•é˜²ç›—é“¾ç»•è¿‡æ˜¯å¦æˆåŠŸ
python test_anti_hotlink.py
```

### 2. æ­£å¸¸ä½¿ç”¨

```bash
# å®Œæ•´æµç¨‹
python main.py --full --max-pages 2 --max-reports 10

# åªä¸‹è½½æŠ¥å‘Š
python main.py --stage4 --max-reports 20

# é‡è¯•å¤±è´¥çš„ä¸‹è½½
python main.py --retry --max-reports 10

# ä¸ä½¿ç”¨ä»£ç†
python main.py --stage4 --no-proxy
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¡®ä¿ Clash è¿è¡Œä¸­**
   - é»˜è®¤ç«¯å£ï¼š7890
   - ç¨‹åºä¼šè‡ªåŠ¨ä½¿ç”¨æœ¬åœ° Clash ä»£ç†

2. **è‡ªåŠ¨åˆ‡æ¢ä»£ç†èŠ‚ç‚¹**
   - é‡åˆ° 403 é”™è¯¯æ—¶è‡ªåŠ¨åˆ‡æ¢ä»£ç†èŠ‚ç‚¹
   - è¿ç»­å¤±è´¥ 2 æ¬¡åè‡ªåŠ¨åˆ‡æ¢
   - åˆ‡æ¢åä¼šæ¸…é™¤ cookies é‡æ–°å»ºç«‹ä¼šè¯

3. **ä¸‹è½½é—´éš”**
   - é»˜è®¤æ¯æ¬¡ä¸‹è½½é—´éš” 2 ç§’
   - é¿å…è§¦å‘é¢‘ç‡é™åˆ¶

4. **å¹¶å‘ä¸‹è½½**
   - `--concurrent` å¯èƒ½è§¦å‘æ›´å¤šé˜²æŠ¤
   - å»ºè®®ä½¿ç”¨é»˜è®¤çš„é¡ºåºä¸‹è½½

5. **Referer è®¾ç½®**
   - å¿…é¡»æ˜¯ `ipoipo.cn` åŸŸå
   - ä¸èƒ½æ˜¯ `ipo.ai-tag.cn`ï¼ˆZIP æ–‡ä»¶æ‰€åœ¨åŸŸåï¼‰

## ğŸ§ª éªŒè¯ä¿®å¤

è¿è¡Œæµ‹è¯•è„šæœ¬åï¼Œé¢„æœŸç»“æœï¼š

| æµ‹è¯• | Referer | é¢„æœŸç»“æœ |
|------|---------|----------|
| æµ‹è¯•1 | æ—  | 403 Forbidden |
| æµ‹è¯•2 | ipoipo.cn/... | 200 OK âœ… |
| æµ‹è¯•3 | example.com | 403 Forbidden |

å¦‚æœæµ‹è¯•2è¿”å›200ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸï¼

## ğŸ“ é—®é¢˜æ’æŸ¥

å¦‚æœä»ç„¶é‡åˆ°403ï¼š

1. æ£€æŸ¥ Clash æ˜¯å¦è¿è¡Œ
2. æ£€æŸ¥ä»£ç†èŠ‚ç‚¹æ˜¯å¦å¯ç”¨
3. ç¡®è®¤ Referer æ ¼å¼æ­£ç¡®
4. å°è¯•åˆ‡æ¢ä»£ç†èŠ‚ç‚¹
5. å¢åŠ è¯·æ±‚é—´éš”æ—¶é—´